<div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-drawer mdl-layout--fixed-header">
  <header class="demo-header mdl-layout__header mdl-color--grey-100 mdl-color-text--grey-600">
    <div class="mdl-layout__header-row">
      <span class="mdl-layout-title">Cara Board</span>
      <div class="mdl-layout-spacer"></div>

      <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" id="hdrbtn">
        <i class="material-icons">more_vert</i>
      </button>
      <ul class="mdl-menu mdl-js-menu mdl-js-ripple-effect mdl-menu--bottom-right" for="hdrbtn">
        <li class="mdl-menu__item">About</li>
        <li class="mdl-menu__item">Contact</li>
        <li class="mdl-menu__item">Legal information</li>
      </ul>
    </div>
  </header>
  <main class="mdl-layout__content mdl-color--grey-100" id="root">
  </main>
</div>

<h1>Simple Echo & Chat Server (<%= @board.screen_name %>)</h1>
<form id="form">
  <input type="text" id="input" value="send a message"></input>
</form>
<div id="msgs"></div>

<script type="text/javascript">
  window.onload = function(){
    (function(){
      var user;
      var show = function(el){
        return function(msg){ el.innerHTML = msg + '<br />' + el.innerHTML; }
      }(document.getElementById('msgs'));
      var ws = new WebSocket('ws://' + window.location.host + window.location.pathname);
      var onMouseMove = function(e) {
        var msg = { type: "mousemove", user: user };
        msg.position = { x: e.clientX, y: e.clientY };
        ws.send(JSON.stringify(msg));
      };
      ws.onopen = function() {
        show('websocket opened');
        document.addEventListener("mousemove", onMouseMove);
      };
      ws.onclose = function() {
        show('websocket closed');
        document.removeEventListener("mousemove", onMouseMove);
      }
      ws.onmessage = function(m) {
        data = JSON.parse(m.data);
        if (data.type === "message") {
          show(data.user.name + ': ' + data.body);
        } else if  (data.type === "mousemove") {
          console.log(data);
        } else if  (data.type === "user") {
          user = data.user;
        }
      };
      var sender = function(f){
        var input     = document.getElementById('input');
        input.onclick = function(){ input.value = "" };
        f.onsubmit    = function(){
          var msg = { type: "message", body: input.value, user: user };
          ws.send(JSON.stringify(msg));
          input.value = "send a message";
          return false;
        }
      }(document.getElementById('form'));
    })();
  }
</script>
